From: Baptiste BEAUPLAT <lyknode@cilg.org>
Date: Sun, 28 Apr 2019 11:35:37 +0200
Subject: Allow anon upload on writeable root

---
 parseconf.c   | 1 +
 tunables.c    | 1 +
 tunables.h    | 1 +
 twoprocess.c  | 3 ++-
 vsftpd.conf.5 | 7 +++++++
 5 files changed, 12 insertions(+), 1 deletion(-)

diff --git a/parseconf.c b/parseconf.c
index b3ebf96..c9f2b86 100644
--- a/parseconf.c
+++ b/parseconf.c
@@ -37,6 +37,7 @@ parseconf_bool_array[] =
   { "anon_upload_enable", &tunable_anon_upload_enable },
   { "anon_mkdir_write_enable", &tunable_anon_mkdir_write_enable },
   { "anon_other_write_enable", &tunable_anon_other_write_enable },
+  { "anon_root_writable", &tunable_anon_root_writable },
   { "chown_uploads", &tunable_chown_uploads },
   { "connect_from_port_20", &tunable_connect_from_port_20 },
   { "xferlog_enable", &tunable_xferlog_enable },
diff --git a/tunables.c b/tunables.c
index a5f694e..c65329f 100644
--- a/tunables.c
+++ b/tunables.c
@@ -18,6 +18,7 @@ int tunable_write_enable;
 int tunable_anon_upload_enable;
 int tunable_anon_mkdir_write_enable;
 int tunable_anon_other_write_enable;
+int tunable_anon_root_writable;
 int tunable_chown_uploads;
 int tunable_connect_from_port_20;
 int tunable_xferlog_enable;
diff --git a/tunables.h b/tunables.h
index 71fb1c8..01ed407 100644
--- a/tunables.h
+++ b/tunables.h
@@ -19,6 +19,7 @@ extern int tunable_write_enable;              /* Global enable writes */
 extern int tunable_anon_upload_enable;        /* Enable STOR for anon users */
 extern int tunable_anon_mkdir_write_enable;   /* MKD for anon */
 extern int tunable_anon_other_write_enable;   /* APPE DELE RMD RNFR for anon */
+extern int tunable_anon_root_writable;        /* Allow anon uploads to root */
 extern int tunable_chown_uploads;             /* chown() anon uploaded files */
 extern int tunable_connect_from_port_20;      /* PORT connects from port 20 */
 extern int tunable_xferlog_enable;            /* Log transfers to a file */
diff --git a/twoprocess.c b/twoprocess.c
index 33d84dc..0da4ca0 100644
--- a/twoprocess.c
+++ b/twoprocess.c
@@ -449,7 +449,8 @@ common_do_login(struct vsf_session* p_sess, const struct mystr* p_user_str,
     {
       secutil_option |= VSF_SECUTIL_OPTION_CHANGE_EUID;
     }
-    if (!was_anon && tunable_allow_writeable_chroot)
+    if ((!was_anon ||
+         tunable_anon_root_writable) && tunable_allow_writeable_chroot)
     {
       secutil_option |= VSF_SECUTIL_OPTION_ALLOW_WRITEABLE_ROOT;
     }
diff --git a/vsftpd.conf.5 b/vsftpd.conf.5
index 92c1b87..98b02d4 100644
--- a/vsftpd.conf.5
+++ b/vsftpd.conf.5
@@ -56,6 +56,13 @@ If set to YES, anonymous users will be permitted to perform write operations
 other than upload and create directory, such as deletion and renaming. This
 is generally not recommended but included for completeness.
 
+Default: NO
+.TP
+.B anon_root_writable
+If set to YES, anonymous users will be permitted to perform upload
+ions
+to the anonymous root directory. Enabling this is a bad idea.
+
 Default: NO
 .TP
 .B anon_upload_enable
